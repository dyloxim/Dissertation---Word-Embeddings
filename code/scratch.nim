import sequtils, sugar, math, strutils, strformat, nimsvg

proc rgb_to_hex(rgb: array[3, float]): string =
  let constrained = rgb.map(x => min(1, max(0, x)))
  var hex_numeric = constrained.map(x => toHex(int(round(x * 255))))
  let hex = hex_numeric.map(x => fmt"{x[^2]}{x[^1]}")
  fmt"#{hex[0]}{hex[1]}{hex[2]}"

proc color_map(neg_end: array[3, float],
               mid_point: array[3, float],
               pos_end: array[3, float],
               bound: float, val: float): string =
  var col_vec = [2.0, 3.0, 4.0]
  for i in 0..2:
    if val > 0:
      col_vec[i] = mid_point[i] + (val/bound) * (pos_end[i] - mid_point[i])
    else:
      col_vec[i] = mid_point[i] + (-val/bound) * (neg_end[i] - mid_point[i])
  return rgb_to_hex(col_vec)

let white = [1.0, 1.0, 1.0]
let red = [1.0, 0.0, 0.0]
let blue = [0.0, 0.0, 1.0]

echo color_map(blue, white, red, 4, -4)
echo color_map(blue, white, red, 4, 0)
echo color_map(blue, white, red, 4, 4)

buildSvgFile("figures/nim/rectangles-1.svg"):
  let size = 500 
  let king = [ 0.50451 ,  0.68607 , -0.59517 , -0.022801,  0.60046 , -0.13498 ,
       -0.08813 ,  0.47377 , -0.61798 , -0.31012 , -0.076666,  1.493   ,
       -0.034189, -0.98173 ,  0.68229 ,  0.81722 , -0.51874 , -0.31503 ,
       -0.55809 ,  0.66421 ,  0.1961  , -0.13495 , -0.11476 , -0.30344 ,
        0.41177 , -2.223   , -1.0756  , -1.0783  , -0.34354 ,  0.33505 ,
        1.9927  , -0.04234 , -0.64319 ,  0.71125 ,  0.49159 ,  0.16754 ,
        0.34344 , -0.25663 , -0.8523  ,  0.1661  ,  0.40102 ,  1.1685  ,
       -1.0137  , -0.21585 , -0.15155 ,  0.78321 , -0.91241 , -1.6106  ,
       -0.64426 , -0.51042 ]
  let man = [-0.094386,  0.43007 , -0.17224 , -0.45529 ,  1.6447  ,  0.40335 ,
       -0.37263 ,  0.25071 , -0.10588 ,  0.10778 , -0.10848 ,  0.15181 ,
       -0.65396 ,  0.55054 ,  0.59591 , -0.46278 ,  0.11847 ,  0.64448 ,
       -0.70948 ,  0.23947 , -0.82905 ,  1.272   ,  0.033021,  0.2935  ,
        0.3911  , -2.8094  , -0.70745 ,  0.4106  ,  0.3894  , -0.2913  ,
        2.6124  , -0.34576 , -0.16832 ,  0.25154 ,  0.31216 ,  0.31639 ,
        0.12539 , -0.012646,  0.22297 , -0.56585 , -0.086264,  0.62549 ,
       -0.0576  ,  0.29375 ,  0.66005 , -0.53115 , -0.48233 , -0.97925 ,
        0.53135 , -0.11725 ]
  let queen = [ 0.37854  ,  1.8233   , -1.2648   , -0.1043   ,  0.35829  ,
        0.60029  , -0.17538  ,  0.83767  , -0.056798 , -0.75795  ,
        0.22681  ,  0.98587  ,  0.60587  , -0.31419  ,  0.28877  ,
        0.56013  , -0.77456  ,  0.071421 , -0.5741   ,  0.21342  ,
        0.57674  ,  0.3868   , -0.12574  ,  0.28012  ,  0.28135  ,
       -1.8053   , -1.0421   , -0.19255  , -0.55375  , -0.054526 ,
        1.5574   ,  0.39296  , -0.2475   ,  0.34251  ,  0.45365  ,
        0.16237  ,  0.52464  , -0.070272 , -0.83744  , -1.0326   ,
        0.45946  ,  0.25302  , -0.17837  , -0.73398  , -0.20025  ,
        0.2347   , -0.56095  , -2.2839   ,  0.0092753, -0.60284  ]
  let woman = [-0.18153,    0.64827, -0.5821,   -0.49451,     1.5415,
        1.345,    -0.43305,  0.58059,   0.35556,    -0.25184  ,
        0.20254,  -0.71643,  0.3061,    0.56127,     0.83928  ,
       -0.38085,  -0.90875,  0.43326,  -0.014436,    0.23725  ,
       -0.53799,   1.7773,  -0.066433,  0.69795,     0.69291  ,
       -2.6739,   -0.76805,  0.33929,   0.19695,    -0.35245  ,
        2.292,    -0.27411, -0.30169,   0.00085286,  0.16923  ,
        0.091433, -0.02361,  0.036236,  0.34488,    -0.83947  ,
       -0.25174,   0.42123,  0.48616,   0.022325,    0.5576   ,
       -0.85223,  -0.23073, -1.3138,    0.48764,    -0.10467  ]
  svg(width=size, height=size):
    for i in 0 .. 49:
      let x_pos = i*10
      rect(x=x_pos, y=0.0, width=10, height=10, stroke="#000000", fill=color_map(blue, white, red, 1, king[i]), `fill-opacity`=0.5)
      rect(x=x_pos, y=20.0, width=10, height=10, stroke="#000000", fill=color_map(blue, white, red, 1, queen[i]), `fill-opacity`=0.5)
      rect(x=x_pos, y=10.0, width=10, height=10, stroke="#000000", fill=color_map(blue, white, red, 1, man[i]), `fill-opacity`=0.5)
      rect(x=x_pos, y=30.0, width=10, height=10, stroke="#000000", fill=color_map(blue, white, red, 1, woman[i]), `fill-opacity`=0.5)

